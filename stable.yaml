#parent=..\global.yaml
---
repo: https://github.com/CodeOptimist/rimworld-jobs-of-opportunity

_anchors:
  - !parent &global_ModMetaData ModMetaData

ModMetaData: !merge
  <: *global_ModMetaData
  url: '{discord}'
  name: Jobs of Opportunity (While You're Up)
  packageId: CodeOptimist.JobsOfOpportunity
  supportedVersions:
    - 1.1
    - 1.2
    - 1.3
  incompatibleWith:
    - hoodie.whileyoureup
    - kevlou127.WhileHYouOreHUpHQ1V0S
  incompatibleWithByVersion:
    v1.3:
      - Mlie.PickUpAndHaul

published_file_id: 2034960453
preview_from_path: '{out_dir}\..\JoO.png'

intro: |-
  [b]Opportunistic hauling and [i]Pick Up And Haul[/i] upgrades.[/b]
  Compatible with existing saves. Any load order.

steam_intro: |-
  {intro}

  [img]https://i.imgur.com/tbpLbha.gif[/img]

header: |-
  [b]A pawn's job will say "Opportunistically", "Optimally", or "Efficiently unloading", otherwise it's a different mod[/b] (e.g. normal hauling; normal hauling with [url=https://steamcommunity.com/sharedfiles/filedetails/?id=1279012058]Pick Up And Haul[/url], or triggered by [url=https://steamcommunity.com/sharedfiles/filedetails/?id=1561769193]Common Sense[/url]).

  [i]Pick Up And Haul[/i] is optional and installed separately.

  "But my pawns are walking farther!"
  Yes. A slightly longer journey now to avoid a [i]much[/i] longer journey next time.

footer: |-


  [h1]Compatibility[/h1]
  [i]Common Sense?[/i] Yup! Incompatible settings have been made mutually exclusive.

  [i]@Modders:[/i] if you set [i]allowOpportunisticPrefix[/i] to [i]false[/i] for a JobDef, it won't allow opportunistic jobs. This is a vanilla feature.

  [h1]Performance[/h1]
  Vanilla's opportunistic hauling was well-optimized for performance, which this mod painstakingly preserves in its enhancements.
  Likewise we aggressively cache all haul destination lookups for all features.

  [h1]Known Issues[/h1]
  [i]Pawns not taking into account travel time around walls.[/i]
  Unfortunately this is a consequence of the straight-line "as the crow flies" math in the vanilla code for opportunities. If this is a huge problem for your map, set [i]Haulable & storage initial closeness[/i] to a stricter setting. Your pawns will find less opportunities.
  This is how vanilla mitigates the problem while still being performant. A good solution is for me to add an option for true pathfinding for those whose machines can handle it.
  Alternatively, build a door. 😉

  [h1]Report Bugs[/h1]
  1. Please save a game when it occurs, then reload to verify it reoccurs.
  2. Disable the mod from its own options menu - did the bug stop? If so...
  3. Send me your save ([i]Options → Open save data folder[/i]). (They zip much smaller.)
  [b]I can now fix your bug in [i]days[/i] instead of [i]months[/i]! 🎉🥳[/b]

  [h1]History[/h1]
  I intended to [url=https://gist.github.com/CodeOptimist/5a740dd803fc370ec43f22ffa8bc953d#file-utils-cs-L48]fork[/url] [url=https://steamcommunity.com/sharedfiles/filedetails/?id=1544626521]While You're Up[/url], until I saw [url=https://github.com/CodeOptimist/rimworld-jobs-of-opportunity/blob/29391b0a075a1dd77d4788777b0137e26390328c/Source/Patch_TryOpportunisticJob.cs]RimWorld 1.0 added it[/url]. This mod improves vanilla's integration, and so is a spiritual successor to [i]While You're Up[/i] 💜.

features:
  - title: Better unloading for [i]Pick Up And Haul[/i]
    at: 2.0.0
    desc: |-
      [i]Pick Up And Haul[/i] is modified so pawns will no longer unload back-and-forth between stockpiles, but choose an efficient path. This is all hauls, not just opportunities!

  - title: Opportunistic hauls
    at: 1.0.0
    desc: |-
      Vanilla has support for opportunities, but with limitations: haulable near your [b]start[/b] position, and stockpile near your job.
      We prefer these, but drop them as requirements to include hauls along the path.

  - title: Skip opportunities when bleeding
    at: 1.1.0
    desc:

  - title: Skip opportunities when forming a caravan
    at: 2.3.0
    desc:

  - title: Opportunity support for [i]Pick Up And Haul[/i]
    at: 1.4.0
    desc: |-
      [i]Pick Up And Haul[/i] is not just triggered for an opportune haulable, but modified to carefully grab only surrounding items whose unload path is also opportunistic.

  - title: Haul extra bill ingredients closer
    at: 1.6.0
    desc:
      If hauling ingredients to storage would bring them closer to their workbench, do that first (grabbing extra).
    settings:
      - name: HaulBeforeCarry_Bills
        desc:

  - title: Haul extra construction supplies closer
    at: 1.0.0
    desc: |-
      If hauling supplies to storage would bring them closer to their blueprint, do that first (grabbing extra).
    steam: |-
      Your builder will never again cross the map to retrieve a [b]single[/b] component.

      [img]https://i.imgur.com/G2oh7Mm.png[/img]
    settings:
      - name: HaulBeforeCarry_Supplies
        desc:

  - title: Mod compatibility via storage building filter
    at: 2.3.0
    desc: |-
      Permit or deny "optimize hauling" for any storage building through settings, or leave it automatically managed.

updates:
  - at: 1.0.0
    desc: |-
      • Support for [url=https://steamcommunity.com/sharedfiles/filedetails/?id=1279012058][i]Mehni's[/i] Pick Up And Haul[/url]!

  - at: 1.1.0
    desc: |-
      • Updated [i]Optimize hauling supplies[/i]
      Now works as expected: instead of denying the inefficient supply job so [i]some[/i] hauler [i]eventually[/i] hauls, the builder themselves will.

  - at: 1.2.0
    desc: |-
      • Hauls are substantially improved on the default "recommended" setting. No longer should distant wood cut or metal mined be neglected.
      (I've integrated the very last vanilla pathing check into this mod's magic.)

      • Setting tooltips updated with detailed descriptions.

  - at: 1.5.0
    desc: |-
      • New job descriptions:
      |img:jobReport|caption:If you don't see this, it's standard hauling or a different mod.|
      • Added [i]Enabled[/i] setting for troubleshooting without restarts.
      • Improved settings and descriptions.

  - at: 1.5.1
    credit: https://steamcommunity.com/id/SakenW
    desc: |-
      • Compatibility with [url=https://steamcommunity.com/sharedfiles/filedetails/?id=1233893175][i]KV's[/i] Infinite Storage[/url]: [i]Optimize hauling supplies[/i] should now work instead of looping on storage and retrieval.

  - at: 1.6.1
    credit: Gwyndolin-chan#8975
    desc: |-
      • Fixed "Optimize hauling ingredients" to no longer cause "Standing" loop when incapable. (Missed a basic check vanilla already did in the "Optimize hauling supplies" scenario.)

  - at: 1.6.2
    credit: Just#1021
    desc: |-
      • Fixed "Optimize hauling ingredients/supplies" to no longer cause "Standing" loop when ingredient is in a pawn inventory. Fixes surgery with [i]Smart Medicine[/i], compatibility with [i]Build From Inventory[/i], and others.

  - at: 2.0.0
    credit: Kellogg''s#0574
    haul_to_equal_priority: Allow "optimize hauling" to same-priority
    desc: |-
      • [i]Optimize hauling ingredients/supplies[/i] will trigger more often:
           - Fixed hauling from existing storage, not just un-stored.
           - New [i]{haul_to_equal_priority}[/i] setting.
           - Checks closest storage (to destination, not item) for closeness to destination.

  # wrapping issues in HugsLib news from e.g. "Prefix " instead of "Prefix"
  - at: 2.0.0
    desc: |-
      • Added "Optimally" and "Efficiently unloading" job prefixes (like "Opportunistically").
      • Updated "Draw special hauls" to include optimized hauls (magenta & cyan).
      • Updated for RimWorld 1.3.

  - at: 2.1.0
    desc: |-
      • Improving storage mod compatibility:
        - A̶d̶d̶e̶d̶ ̶"̶S̶t̶o̶c̶k̶p̶i̶l̶e̶s̶ ̶o̶n̶l̶y̶"̶ ̶s̶e̶t̶t̶i̶n̶g̶ ̶(̶o̶n̶ ̶b̶y̶ ̶d̶e̶f̶a̶u̶l̶t̶)̶.̶
        - Switched to vanilla-style settings window (future room for a storage building allow-list).

      • Setting for "Draw special hauls" is now saved.
          Try it out, it's fun! See tooltip for description.

  - at: 2.1.1
    credit: https://steamcommunity.com/profiles/76561198110437158
    desc: |-
      • Fixed hauling loop issue with PUAH, chunks, and multiple dumping stockpiles.

  - at: 2.1.2
    credit: https://steamcommunity.com/id/macbuk
    desc: |-
      • Fixed inventory hauling check to work with non-Pawns (e.g. [i]Misc. Robots[/i] mod).

  - at: 2.1.3
    credit: https://steamcommunity.com/profiles/76561197971649772
    desc: |-
      • Fixed "Optimal" hauls occasionally being recalculated many times in 1 tick.

  - at: 2.1.4
    credit: https://steamcommunity.com/id/thispagesucks
    desc: |-
      • Fixed recent "̶S̶t̶o̶c̶k̶p̶i̶l̶e̶s̶ ̶o̶n̶l̶y̶"̶ ̶s̶e̶t̶t̶i̶n̶g̶ accidentally applying to all inventory hauling (PUAH).
      • Clarity improvements to mod settings dialog.

  - at: 2.3.0
    desc: |-
      • If willing, please report issues immediately via Discord link here ↗ or in Mods menu.

  - at: 3.0.0
    desc: |-
      • Performance & future-compatibility update.
        - Added caching to speed up Pick Up And Haul, and While You're Up (this).
        - Re-implemented 'Allow "optimize hauling" to same-priority'.
        - Code layout improvements for easier complex-mod compatibility.

  - at: 3.0.1
    desc: |-
      • Fixed "Optimize hauling" grabbing extras that unload to different storage!

keyed:
  - name: Opportunity_LoadReport
    value: &oLoad '{{ORIGINAL}} on the way to {{TARGET}}.'

  - name: Opportunity_UnloadReport
    value: *oLoad

  - name: Opportunity_Tab
    value: Hauls of Opportunity

  - name: Opportunity_Intro
    value: |-
      Hauling on the way to a job is a vanilla feature, hence generally compatible with all mods. Some storage mods use delays, so are disallowed by default.

      We skip opportunities when bleeding or forming a caravan.

  - name: HaulBeforeCarry_LoadReport
    value: '{{ORIGINAL}}, to bring closer to {{TARGET}}.'

  - name: HaulBeforeCarry_UnloadReport
    value: '{{ORIGINAL}} closer to {{TARGET}}.'

  - name: HaulBeforeCarry_Tab
    value: Supplies & Ingredients

  - name: HaulBeforeCarry_Intro
    value: |-
      A pawn will find the closest resource, which is sometimes waiting delivery to storage near our job site. If we perform that haul first, they can grab extras to expedite future work (often their very next).

  - name: HaulBeforeCarry_EqualPriority
    value: |-
      If a resource is already in storage of equal priority, they won't save a trip for a dedicated hauler, but can still expedite their future work.

  - name: PickUpAndHaulPlus_LoadReport
    value: '{{ORIGINAL}}.'

  - name: PickUpAndHaulPlus_UnloadReport
    value: 'Efficiently {{ORIGINAL}}.'

  - name: PickUpAndHaul_Tab
    value: Pick Up And Haul

  - name: PickUpAndHaul_UpgradeText
    value: |-
      We significantly enhance Pick Up And Haul by unloading only once at each destination, in closest order.

      We improve PUAH's performance by caching haulable destinations (when they cannot change).

  - name: PickUpAndHaul_IntegrationText
    value: |-
      We fully integrate opportunities by ensuring our entire gather & unload path never exceeds our criteria for "opportunistic".

      When hauling extra supplies or ingredients to closer storage, we only grab additions destined to the same storage.

settings:
  - name: Enabled
    title: Enabled
    desc: |-
      Toggle mod without restarting.

  - name: UsePickUpAndHaulPlus
    title: Use & improve Pick Up And Haul
    desc: |-
      Enables: efficient unloading and using inventory for all features.

  - name: Opportunity_ToStockpiles
    title: &toStockpiles Work with stockpiles

  - name: Opportunity_AutoBuildings
    title: &autoBuildings Auto-manage buildings (updated from feedback)

  - name: HaulBeforeCarry_ToStockpiles
    title: *toStockpiles

  - name: HaulBeforeCarry_ToEqualPriority
    title: Allow hauling extra resources to same-priority

  - name: HaulBeforeCarry_AutoBuildings
    title: *autoBuildings

  - name: Opportunity_HaulProximities
    title: Closeness of haulable to pawn *start* position & storage to job
    desc: |-
      The primary way we improve on vanilla's opportunistic hauling, implemented as performantly as possible.

      Set "required" if pawns are having difficulty with long walls, until I add a true pathfinding option.

  - name: Opportunity_HaulProximities_Both
    title: Require both (vanilla)
  - name: Opportunity_HaulProximities_Either
    title: Require either one
  - name: Opportunity_HaulProximities_Ignored
    title: Prefer both, require neither (recommended)

  - name: DrawSpecialHauls
    title: Draw special hauls
    desc: |-
      Original job paths are red, new opportunistic paths are green.

      Original ingredient/supply paths are magenta, new optimal paths are cyan.

      (This is sync'd to vanilla's [i]Development mode → inspector icon → Visibility → Draw Opportunistic Jobs[/i].)

  - name: Opportunity_TweakVanilla
    title: Show advanced vanilla settings...
    desc: |-
      Provided for explaining and tweaking vanilla's built-in opportunistic hauling.

      A value of 0 will skip a check.

      All distances are straight-line ("as the crow flies").

  - name: Opportunity_MaxNewLegsPctOrigTrip
    title: Max new legs % of original trip
    desc: |-
      Max start-to-haulable + storage-to-job % of original trip.
  - name: Opportunity_MaxTotalTripPctOrigTrip
    title: Max total trip % of original trip

  - name: Opportunity_MaxStartToThing
    title: Max start-to-haulable
  - name: Opportunity_MaxStartToThingPctOrigTrip
    title: Max start-to-haulable % of original trip
  - name: Opportunity_MaxStartToThingRegionLookCount
    title: Max start-to-haulable region look count
    desc: &region_look_count |-
      This parameter limits our actual pathing.
      To understand it, enable [i]Development mode → inspector icon → Visibility → Draw Regions[/i].

      Exploration begins from the start region spreading out to all neighbors until encountering the destination region. This setting caps the total number explored - even those in the wrong direction.

      It can't be calculated perfectly from distance, as regions will vary in size and neighbors. (A corridor has only forward and back, so they're explored further.)
      But in a completely open field, if a pawn must travel the distance of n=3 full-sized 12x12 regions (~36 tiles), the algorithm will explore 2(n^2+n)+1 or 25 regions.
  - name: Opportunity_MaxStoreToJob
    title: Max storage-to-job
  - name: Opportunity_MaxStoreToJobPctOrigTrip
    title: Max storage-to-job % of original trip
  - name: Opportunity_MaxStoreToJobRegionLookCount
    title: Max storage-to-job region look count
    desc: *region_look_count
